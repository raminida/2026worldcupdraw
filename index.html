<!DOCTYPE html>
<html lang="ko">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0JTV8VKBEJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0JTV8VKBEJ');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 World Cup Simulator (Balanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0f172a; 
            color: #e2e8f0;
            position: relative;
            padding-bottom: 180px; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://images.unsplash.com/photo-1504305754058-2f08ccd89a05?q=80&w=2070&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            z-index: -1;
            pointer-events: none;
        }

        .group-card {
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            background-color: rgba(30, 41, 59, 0.9);
            border: 1px solid rgba(51, 65, 85, 0.5);
            display: flex;
            flex-direction: column;
        }
        
        .team-highlight {
            background: linear-gradient(90deg, rgba(200, 16, 46, 0.3) 0%, rgba(0, 71, 160, 0.3) 100%);
            font-weight: bold;
            color: #fbbf24;
        }

        .flag-icon {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
            display: inline-block;
            vertical-align: middle;
        }

        /* Happiness Circuit Widget */
        .happiness-widget {
            position: fixed;
            top: 70px;
            right: -360px;
            width: 360px; 
            max-width: 90%;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid #334155;
            border-left: 4px solid #34d399;
            border-radius: 12px 0 0 12px;
            padding: 16px;
            z-index: 100;
            backdrop-filter: blur(10px);
            box-shadow: -10px 10px 30px rgba(0,0,0,0.5);
            transition: right 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            height: auto;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .happiness-widget.active { right: 0; }

        @media (max-width: 768px) {
            .happiness-widget {
                top: 60px;
                max-height: 75vh;
            }
        }

        /* Toggle Button */
        .widget-toggle-btn {
            position: fixed;
            top: 130px;
            right: 0; 
            z-index: 101;
            background: #34d399;
            color: #0f172a;
            padding: 12px 14px 12px 18px;
            border-radius: 30px 0 0 30px;
            box-shadow: -2px 2px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            font-weight: bold;
            transition: right 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex !important;
        }
        
        .widget-toggle-btn:active { transform: scale(0.95); }

        .widget-toggle-btn.open {
            right: 360px; 
            background: #334155;
            color: white;
        }

        @media (max-width: 768px) {
            .widget-toggle-btn.open { right: 90%; }
        }

        .lang-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 50;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: bold;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #60a5fa;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .lang-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }

        .bracket-container {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            padding: 40px 20px;
            min-height: 70vh; 
            align-items: center; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .round-column {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 200px;
            margin-right: 25px;
            position: relative;
            transition: all 0.5s ease;
        }

        .round-column.collapsed {
            min-width: 0;
            width: 0;
            margin-right: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .round-header {
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: #94a3b8;
            position: absolute;
            top: -40px;
            width: 100%;
            font-size: 1rem;
        }
        
        .match-node {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #475569;
            border-radius: 8px; 
            padding: 8px;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            margin-bottom: 0; 
            transition: all 0.3s;
        }

        .match-node.live-match {
            border-color: #fbbf24;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            animation: pulseBorder 0.5s infinite;
        }
        @keyframes pulseBorder {
            0% { border-color: #fbbf24; transform: scale(1); }
            50% { border-color: #f59e0b; transform: scale(1.02); }
            100% { border-color: #fbbf24; transform: scale(1); }
        }
        
        /* Goal Flash Animation */
        @keyframes goalFlash {
            0% { color: #fbbf24; transform: scale(1); }
            50% { color: #fff; transform: scale(1.5); text-shadow: 0 0 10px #fbbf24; }
            100% { color: #fbbf24; transform: scale(1); }
        }
        .goal-scored { animation: goalFlash 0.4s ease-out; }

        .round-column:not(:last-child) .match-node::after {
            content: '';
            position: absolute;
            right: -25px; 
            top: 50%;
            width: 25px;
            height: 2px;
            background: #475569;
            z-index: -1;
        }
        
        .match-node.active-match { 
            border-color: #34d399; 
            box-shadow: 0 0 20px rgba(52, 211, 153, 0.4); 
            transform: scale(1.02);
            z-index: 10;
            background: #1e293b;
        }
        
        .team-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem; 
            height: 30px;
            background: rgba(0,0,0,0.2);
            margin: 3px 0;
        }
        .team-slot.winner { background: rgba(16, 185, 129, 0.2); font-weight: bold; color: #34d399; }
        
        /* Score Font */
        .score-display { 
            font-family: 'Noto Sans KR', sans-serif !important; 
            font-size: 1.6rem; 
            font-weight: 900; 
            color: #fbbf24; 
            text-shadow: 2px 2px 0px rgba(0,0,0,0.8);
            min-width: 30px;
            text-align: center;
            line-height: 1;
        }

        /* PK Display */
        .pk-display {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 0.75rem;
            color: #cbd5e1;
            margin-top: 6px;
            font-weight: bold;
            background: rgba(0,0,0,0.6);
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid rgba(251, 191, 36, 0.3);
            letter-spacing: 1px;
            white-space: nowrap;
            overflow-x: auto;
        }
        
        .pk-o { color: #34d399; } 
        .pk-x { color: #ef4444; } 

        @media (min-width: 768px) {
            .round-column { min-width: 280px; margin-right: 50px; }
            .round-column:not(:last-child) .match-node::after { right: -50px; width: 50px; }
            .match-node { padding: 12px; border-radius: 10px; }
            .team-slot { height: 36px; font-size: 0.95rem; margin: 4px 0; }
            .round-header { font-size: 1.2rem; top: -50px; }
            .score-display { font-size: 1.8rem; }
        }

        .sticky-footer {
            background: linear-gradient(0deg, rgba(15, 23, 42, 1) 20%, rgba(15, 23, 42, 0.95) 80%, rgba(15, 23, 42, 0) 100%);
            padding-bottom: env(safe-area-inset-bottom, 20px); 
        }

        .league-table th, .league-table td { padding: 6px 8px; }
        .league-table th { color: #94a3b8; font-weight: normal; font-size: 0.75rem; }
        .league-table td { color: #e2e8f0; font-size: 0.85rem; }
        
        .qualify-zone { border-left: 4px solid #34d399; background: linear-gradient(90deg, rgba(52, 211, 153, 0.1) 0%, transparent 100%); }
        .wildcard-zone { border-left: 4px solid #34d399; background: linear-gradient(90deg, rgba(52, 211, 153, 0.1) 0%, transparent 100%); } 
        .eliminate-zone { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%); }

        .tooltip { display: none; } 
        .group-desc { display: none; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        .winner-modal { animation: zoomIn 0.5s ease-out forwards; }
        @keyframes zoomIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .star-pop { animation: starPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(3); }
        @keyframes starPop { to { opacity: 1; transform: scale(1); } }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        .custom-select {
            background-color: #1e293b;
            color: #e2e8f0;
            border: 1px solid #475569;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .stat-row { margin-bottom: 12px; }
        .stat-label { display: flex; justify-content: space-between; font-size: 0.85rem; color: #cbd5e1; margin-bottom: 4px; font-family: 'Noto Sans KR', sans-serif; }
        .stat-track { width: 100%; background-color: #1e293b; border-radius: 6px; height: 16px; overflow: hidden; border: 1px solid #334155; }
        .stat-fill { height: 100%; border-radius: 6px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 0 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <canvas id="confetti-canvas"></canvas>

    <header class="bg-slate-900/90 backdrop-blur-md border-b border-slate-700 p-4 text-center shadow-lg relative z-10">
        <button onclick="toggleLanguage()" id="langBtn" class="lang-btn"><i class="fas fa-globe mr-2"></i>Language: EN</button>
        <h1 class="text-2xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-white to-emerald-400 drop-shadow-lg" data-key="title">2026 FIFA WORLD CUP™</h1>
        <p class="text-slate-400 mt-1 text-[10px] md:text-xs font-bold tracking-[0.2em] uppercase" data-key="headerSub">Simulator Final - Balanced</p>
    </header>

    <!-- Toggle Button -->
    <div id="widgetToggle" class="widget-toggle-btn" onclick="toggleWidget()"><i class="fas fa-chart-bar text-xl"></i></div>

    <div id="happinessWidget" class="happiness-widget">
        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2 sticky top-0 bg-slate-900/95 z-10 pt-1">
            <h3 class="text-lg font-bold text-emerald-400" data-key="happinessTitle"><i class="fas fa-calculator mr-2"></i>행복회로</h3>
            <button onclick="toggleWidget()" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div class="mb-4">
            <label class="text-xs text-slate-400 mb-1 block" data-key="selectTarget">응원할 국가 선택</label>
            <select id="targetCountrySelect" class="custom-select" onchange="changeTargetTeam(this.value)"></select>
        </div>
        <div id="probSection" class="mb-5 bg-slate-800/50 p-3 rounded border border-slate-700">
            <div class="flex justify-between text-sm text-slate-300 mb-1">
                <span class="font-bold flex items-center gap-2">
                    <img id="probFlag" src="https://flagcdn.com/w20/kr.png" class="w-5 h-3">
                    <span data-key="probLabel">32강 진출 확률</span>
                </span>
                <span id="probText" class="font-mono text-emerald-300 font-bold text-lg">--%</span>
            </div>
            <div class="w-full bg-slate-700 rounded-full h-3 overflow-hidden shadow-inner">
                <div id="probBar" class="bg-gradient-to-r from-red-600 via-yellow-500 to-emerald-500 h-full rounded-full transition-all duration-700" style="width: 0%"></div>
            </div>
        </div>
        <div class="mb-6">
            <button onclick="simulateLeagueRound()" id="widgetSimBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg mb-3 transition flex justify-center items-center text-sm active:scale-95">
                <i class="fas fa-play mr-2"></i> <span id="widgetSimBtnText" data-key="simBtn">조별리그 1차전 진행</span>
            </button>
            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1 ml-1" data-key="scheduleLabel">우리 조 일정표</div>
            <div class="bg-slate-800 rounded border border-slate-700 overflow-hidden p-2 min-h-[100px] overflow-y-auto custom-scrollbar" id="targetGroupMatches">
                <div class="text-xs text-slate-600 text-center italic py-4" data-key="scheduleEmpty">조 추첨 후 일정이 생성됩니다.</div>
            </div>
        </div>
        <div>
            <div class="flex justify-between items-end mb-2 px-1">
                <div class="text-xs text-yellow-400 uppercase tracking-wider font-bold"><i class="fas fa-crown mr-1"></i><span data-key="wildcardTitle">와일드카드 (Top 8)</span></div>
                <div class="text-[10px] text-slate-500" data-key="wildcardDesc">8위까지 생존</div>
            </div>
            <div class="bg-slate-800/50 rounded border border-slate-700/50 overflow-hidden">
                <table class="w-full text-left border-separate border-spacing-0">
                    <thead>
                        <tr class="text-slate-500 border-b border-slate-700 text-[10px] bg-slate-800">
                            <th class="w-8 text-center p-2 border-b border-slate-700">#</th>
                            <th class="p-2 border-b border-slate-700" data-key="tableTeam">Team</th>
                            <th class="text-center p-2 border-b border-slate-700" data-key="tablePts">Pts</th>
                            <th class="text-center p-2 border-b border-slate-700">GD</th>
                        </tr>
                    </thead>
                    <tbody id="thirdPlaceBody" class="text-xs"></tbody>
                </table>
            </div>
        </div>
        <div class="h-4"></div>
    </div>

    <div class="bg-slate-900/95 border-b border-slate-800 sticky top-0 z-20 backdrop-blur-sm">
        <div class="container mx-auto px-2 flex justify-around md:justify-center md:gap-12">
            <button onclick="switchTab('draw')" id="tab-draw" class="py-3 px-2 font-bold text-base md:text-lg tab-active transition-all border-b-2 border-transparent"><i class="fas fa-th-large mr-1"></i><span data-key="tabDraw">조별리그</span></button>
            <button onclick="switchTab('tournament')" id="tab-tournament" class="py-3 px-2 font-bold text-base md:text-lg tab-inactive transition-all border-b-2 border-transparent hidden"><i class="fas fa-trophy mr-1"></i><span data-key="tabTournament">32강</span></button>
            <button onclick="switchTab('report')" id="tab-report" class="py-3 px-2 font-bold text-base md:text-lg tab-inactive transition-all border-b-2 border-transparent"><i class="fas fa-chart-pie mr-1"></i><span data-key="tabReport">데이터 센터</span></button>
        </div>
    </div>

    <main class="flex-grow relative overflow-hidden w-full">
        <section id="section-draw" class="container mx-auto px-2 md:px-4 py-4 h-full overflow-y-auto">
            <div id="fixedInfo" class="text-center mb-6 text-xs md:text-sm text-slate-400 flex justify-center items-center gap-2 flex-wrap bg-slate-800/50 p-2 rounded-lg border border-slate-700/50 mx-auto max-w-xl">
                <span class="bg-slate-900/80 px-2 py-1 rounded border border-slate-700 text-[10px] text-emerald-400 font-bold" data-key="fixed">FIXED</span> 
                <span class="flex items-center text-slate-300"><img src="https://flagcdn.com/w40/mx.png" class="w-4 h-3 mr-1 inline"> A1</span>
                <span class="flex items-center text-slate-300"><img src="https://flagcdn.com/w40/ca.png" class="w-4 h-3 mr-1 inline"> B1</span>
                <span class="flex items-center text-slate-300"><img src="https://flagcdn.com/w40/us.png" class="w-4 h-3 mr-1 inline"> D1</span>
                <span class="border-l border-slate-600 mx-1 h-3"></span>
                <span class="flex items-center text-yellow-500" title="Rank 4"><img src="https://flagcdn.com/w40/gb-eng.png" class="w-4 h-3 mr-1 inline"> C1</span>
                <span class="flex items-center text-yellow-500" title="Rank 3"><img src="https://flagcdn.com/w40/fr.png" class="w-4 h-3 mr-1 inline"> E1</span>
                <span class="flex items-center text-yellow-500" title="Rank 1"><img src="https://flagcdn.com/w40/es.png" class="w-4 h-3 mr-1 inline"> G1</span>
                <span class="flex items-center text-yellow-500" title="Rank 2"><img src="https://flagcdn.com/w40/ar.png" class="w-4 h-3 mr-1 inline"> L1</span>
            </div>
            <div id="groupsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 pb-32"></div>
        </section>

        <section id="section-tournament" class="container mx-auto px-2 md:px-4 py-4 hidden h-full overflow-y-auto custom-scrollbar">
            <div class="max-w-full mx-auto pb-48 relative">
                <div id="r32CollapseBtn" class="hidden absolute top-2 left-2 z-20 bg-slate-700 text-white px-3 py-1 rounded text-xs md:text-sm cursor-pointer hover:bg-slate-600 shadow-lg" onclick="toggleR32()"><i class="fas fa-chevron-left mr-1"></i><span data-key="collapse32">32강 접기</span></div>
                <div id="tournamentBracket" class="bracket-container">
                     <div class="text-center text-slate-500 py-20 w-full" data-key="tournamentWait"><i class="fas fa-lock text-4xl mb-4 opacity-50"></i><br>조별리그가 완료되어야 합니다.</div>
                </div>
            </div>
        </section>

        <section id="section-report" class="container mx-auto px-4 py-8 hidden h-full overflow-y-auto custom-scrollbar">
             <div class="max-w-3xl mx-auto pb-32">
                <div class="bg-slate-800/90 backdrop-blur rounded-xl p-6 shadow-2xl border border-slate-700 text-center mb-8">
                    <h2 class="text-xl font-bold text-white mb-4" data-key="reportTitle">시뮬레이션 데이터 센터</h2>
                    
                    <div class="bg-slate-700/50 p-4 rounded-lg inline-block w-full max-w-md">
                        <div class="mb-3 text-sm text-slate-300 text-left" data-key="selectTargetSim">시뮬레이션 타겟 국가</div>
                        <select id="simTargetSelect" class="custom-select mb-4" style="background: #0f172a; border-color: #334155;"></select>
                        <button onclick="runBatchSimulation()" id="batchSimBtn" class="w-full bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-500 hover:to-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg transition active:scale-95">
                            <i class="fas fa-robot mr-2"></i><span data-key="run100">시뮬레이션 100회 가동</span>
                        </button>
                    </div>
                </div>

                <div id="simLoading" class="hidden text-center py-12">
                    <i class="fas fa-circle-notch fa-spin text-4xl text-emerald-400 mb-4"></i>
                    <div class="text-slate-400 animate-pulse mt-2 font-bold text-lg">Running 100 World Cups...</div>
                </div>

                <div id="reportResults" class="hidden space-y-6">
                     <!-- Stats Summary -->
                     <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                        <h3 class="text-emerald-400 font-bold mb-4 border-b border-slate-700 pb-2"><i class="fas fa-chart-bar mr-2"></i><span data-key="roundStats">라운드별 진출 횟수</span></h3>
                        <div class="space-y-4" id="roundStatsContainer">
                            <!-- Vertical Bars injected here -->
                        </div>
                     </div>

                     <!-- Group Analysis -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-red-400 font-bold mb-2 text-sm"><i class="fas fa-skull mr-2"></i><span data-key="worstGroup">타겟 국가 최악의 조 (Worst)</span></h3>
                            <div id="worstCaseContent" class="bg-slate-900/50 p-2 rounded"></div>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-yellow-400 font-bold mb-2 text-sm"><i class="fas fa-gift mr-2"></i><span data-key="bestGroup">타겟 국가 최고의 조 (Best)</span></h3>
                            <div id="bestCaseContent" class="bg-slate-900/50 p-2 rounded"></div>
                        </div>
                     </div>

                     <!-- Nemesis & Winners -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-purple-400 font-bold mb-2 text-sm"><i class="fas fa-user-ninja mr-2"></i><span data-key="nemesis">담당일진 (탈락시킨 팀)</span></h3>
                            <ul id="nemesisList" class="space-y-1 text-sm custom-scrollbar max-h-48 overflow-y-auto"></ul>
                        </div>
                        <div class="bg-slate-800 p-4 rounded-lg border border-slate-700">
                            <h3 class="text-yellow-500 font-bold mb-2 text-sm"><i class="fas fa-trophy mr-2"></i><span data-key="topWinners">우승국 TOP 5</span></h3>
                            <ul id="winnerList" class="space-y-1 text-sm"></ul>
                        </div>
                     </div>
                </div>
            </div>
        </section>
    </main>

    <div id="drawController" class="fixed bottom-0 left-0 w-full sticky-footer p-3 z-50 flex justify-center items-end pb-6 md:pb-8" style="display: none;">
        <div class="bg-slate-800/95 backdrop-blur-md border border-slate-600 rounded-2xl shadow-2xl p-3 flex items-center gap-3 w-full max-w-2xl mx-2 relative overflow-visible transition-all duration-300">
            <div id="drawControlsGroup" class="flex items-center w-full relative">
                <button onclick="drawNextStep()" id="lotteryBtn" class="bg-gradient-to-b from-emerald-400 to-emerald-600 hover:from-emerald-300 hover:to-emerald-500 text-white rounded-full w-16 h-16 md:w-20 md:h-20 flex items-center justify-center shadow-lg border-4 border-slate-900 absolute -top-6 left-4 md:left-8 transition active:scale-95 z-20">
                    <i class="fas fa-dice text-2xl md:text-3xl animate-pulse"></i>
                </button>
                <div class="flex-grow pl-20 md:pl-32 pr-2 py-1">
                    <div class="text-[10px] md:text-xs text-slate-400 uppercase font-bold tracking-wider">Live Status</div>
                    <div id="drawStatusText" class="text-sm md:text-lg font-black text-white truncate">Ready</div>
                </div>
                <div class="flex gap-2"><button onclick="resetDraw()" class="text-slate-400 hover:text-white px-3 py-2 bg-slate-700/50 rounded-lg"><i class="fas fa-undo"></i></button></div>
            </div>
            <div id="leagueControlsGroup" class="hidden w-full flex items-center justify-between pl-2">
                <div class="flex-grow">
                    <div class="text-[10px] md:text-xs text-slate-400 uppercase font-bold tracking-wider">Group Stage</div>
                    <div id="leagueStatusText" class="text-sm md:text-lg font-black text-white truncate">Round 1 Ready</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="simulateLeagueRound()" id="leagueNextBtn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-xl shadow-lg transition flex items-center text-sm md:text-base"><i class="fas fa-play mr-1 md:mr-2"></i> <span class="hidden md:inline" data-key="roundProceed">라운드 진행</span><span class="md:hidden" data-key="roundProceedShort">진행</span></button>
                    <button onclick="startTournament()" id="toTournamentBtn" class="hidden bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-xl shadow-lg transition flex items-center text-sm md:text-base"><i class="fas fa-trophy mr-1 md:mr-2"></i> <span data-key="go32">32강 진출</span></button>
                    <button onclick="resetDraw()" class="text-slate-400 hover:text-white px-3 py-2 bg-slate-700/50 rounded-lg"><i class="fas fa-undo"></i></button>
                </div>
            </div>
            <div id="tournamentControlsGroup" class="hidden w-full flex items-center justify-between pl-2">
                <div class="flex-grow">
                    <div class="text-[10px] md:text-xs text-slate-400 uppercase font-bold tracking-wider">Tournament</div>
                    <div id="tournamentStatusText" class="text-sm md:text-lg font-black text-amber-400 truncate">Round of 32</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="runNextMatch()" id="nextMatchBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 md:py-3 md:px-6 rounded-xl shadow-lg transition flex items-center text-sm md:text-base"><i class="fas fa-futbol mr-1 md:mr-2"></i> <span class="hidden md:inline" data-key="nextMatch">다음 경기</span><span class="md:hidden" data-key="nextMatchShort">다음</span></button>
                    <button onclick="resetDraw()" class="text-slate-400 hover:text-white px-3 py-2 bg-slate-700/50 rounded-lg"><i class="fas fa-undo"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="initialControls" class="fixed bottom-8 left-0 w-full flex justify-center z-40 px-4 pointer-events-none">
        <div class="pointer-events-auto bg-slate-800/95 backdrop-blur p-4 rounded-2xl shadow-2xl border border-slate-700 flex flex-col gap-3 w-full max-w-sm">
            <button onclick="startLiveDraw()" class="bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-500 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg text-lg w-full"><i class="fas fa-play-circle mr-2"></i> <span data-key="startLive">실시간 추첨 시작</span></button>
            <div class="grid grid-cols-1">
                 <button onclick="startSingleDraw()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 font-bold py-3 px-4 rounded-xl text-sm w-full"><i class="fas fa-fast-forward mr-2"></i> <span data-key="startResult">결과만 보기</span></button>
            </div>
        </div>
    </div>

    <div id="lotteryModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 hidden backdrop-blur-sm p-4">
        <div class="bg-slate-900 border-2 border-emerald-500/50 p-8 rounded-2xl shadow-2xl text-center max-w-xs w-full transform transition-all scale-100">
            <div class="mb-6 relative h-24 flex items-center justify-center overflow-hidden bg-slate-800 rounded-xl inner-shadow">
                <div id="spinningContent" class="text-4xl font-black text-white"><i class="fas fa-futbol text-5xl text-slate-700 animate-spin"></i></div>
            </div>
            <h3 id="lotteryTitle" class="text-lg font-bold text-emerald-400 mb-2">Drawing...</h3>
        </div>
    </div>

    <div id="winnerModal" class="fixed inset-0 z-[120] flex items-center justify-center bg-black/90 hidden winner-modal p-4">
        <div class="text-center relative w-full max-w-md">
            <h2 class="text-3xl md:text-5xl font-black text-yellow-400 mb-4 drop-shadow-lg animate-pulse">WORLD CHAMPION</h2>
            <div class="relative inline-block mb-8">
                <img id="winnerFlag" src="" class="w-full max-w-[280px] h-auto mx-auto rounded shadow-2xl border-4 border-yellow-500 object-cover">
                <div id="starsContainer" class="absolute -top-8 left-0 w-full flex justify-center gap-2 flex-wrap"></div>
            </div>
            <div id="winnerName" class="text-4xl md:text-6xl font-black text-white tracking-widest uppercase mb-8">KOREA</div>
            <button onclick="closeWinnerModal()" class="bg-slate-700 hover:bg-slate-600 text-white px-8 py-3 rounded-full text-lg font-bold shadow-lg border border-slate-500" data-key="close">닫기</button>
        </div>
    </div>

    <script>
        const translations = {
            ko: {
                title: "2026 북중미 월드컵 시뮬레이터",
                headerSub: "Simulator Final - 불양TV 버전",
                happinessTitle: "행복회로",
                selectTarget: "응원할 국가 선택",
                probLabel: "32강 진출 확률",
                simBtn: "조별리그 1차전 진행",
                scheduleLabel: "우리 조 일정표",
                scheduleEmpty: "조 추첨 후 일정이 생성됩니다.",
                wildcardTitle: "와일드카드 (Top 8)",
                wildcardDesc: "8위까지 생존",
                tableTeam: "팀",
                tablePts: "승점",
                tabDraw: "조별리그",
                tabTournament: "32강",
                tabReport: "데이터 센터",
                fixed: "고정",
                collapse32: "32강 접기",
                expand32: "32강 보기",
                tournamentWait: "조별리그가 완료되어야 합니다.",
                reportTitle: "시뮬레이션 데이터 센터",
                selectTargetSim: "시뮬레이션 타겟 국가",
                run100: "시뮬레이션 100회 가동",
                roundStats: "라운드별 진출 횟수",
                worstGroup: "타겟 국가 최악의 조 (Worst)",
                bestGroup: "타겟 국가 최고의 조 (Best)",
                nemesis: "담당일진 (탈락시킨 팀)",
                topWinners: "우승국 TOP 5",
                roundProceed: "라운드 진행",
                roundProceedShort: "진행",
                go32: "32강 진출",
                nextMatch: "다음 경기",
                nextMatchShort: "다음",
                startLive: "실시간 추첨 시작",
                startResult: "결과만 보기",
                close: "닫기",
                r32: "32강", r16: "16강", qf: "8강", sf: "4강", final: "결승", winner: "우승", groupOut: "조별 탈락"
            },
            en: {
                title: "2026 World Cup Simulator",
                headerSub: "Simulator Final - BoolyangTV Ver",
                happinessTitle: "Happiness Circuit",
                selectTarget: "Select Target Team",
                probLabel: "Qualify Probability",
                simBtn: "Simulate Match",
                scheduleLabel: "Group Schedule",
                scheduleEmpty: "Schedule appears after draw.",
                wildcardTitle: "Wildcard (Top 8)",
                wildcardDesc: "Top 8 advance",
                tableTeam: "Team",
                tablePts: "Pts",
                tabDraw: "Group Stage",
                tabTournament: "Knockout",
                tabReport: "Data Center",
                fixed: "Fixed",
                collapse32: "Collapse R32",
                expand32: "View R32",
                tournamentWait: "Group Stage must finish first.",
                reportTitle: "Simulation Data Center",
                selectTargetSim: "Simulation Target Team",
                run100: "Run 100 Simulations",
                roundStats: "Survival Count by Round",
                worstGroup: "Target's Group of Death",
                bestGroup: "Target's Easiest Group",
                nemesis: "Nemesis (Eliminated By)",
                topWinners: "Top 5 Winners",
                roundProceed: "Play Round",
                roundProceedShort: "Play",
                go32: "Go to R32",
                nextMatch: "Next Match",
                nextMatchShort: "Next",
                startLive: "Start Live Draw",
                startResult: "Quick Result",
                close: "Close",
                r32: "Round of 32", r16: "Round of 16", qf: "Quarter-Finals", sf: "Semi-Finals", final: "Final", winner: "Winner", groupOut: "Group Stage Exit"
            }
        };

        let currentLang = 'ko';
        let targetTeamCode = 'kr';
        let simTargetCode = 'kr';
        let isMatchAnimating = false;

        // Global State Variables
        let isDrawing = false;
        let liveDrawState = { active: false, groups: [], currentPot: 0, currentGroupIndex: 0, currentStep: 0, totalSteps: 48, currentLeagueRound: 0, groupSchedule: [] };
        let tournamentState = { active: false, rounds: [], currentRoundIndex: 0, currentMatchIndex: 0 };
        let confettiAnimationId = null;

        const groupNames = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L"];

        const groupLogistics = {
            A: { slots: ["966km", "3967km", "639km", "4566km"] },
            B: { slots: ["3354km", "5059km", "1468km", "2296km"] },
            C: { slots: ["2008km", "1506km", "1804km", "1766km"] },
            D: { slots: ["3091km", "559km", "1285km", "1836km"] },
            E: { slots: ["3327km", "1100km", "2802km", "2641km"] },
            F: { slots: ["1726km", "1402km", "1588km", "1030km"] },
            G: { slots: ["1929km", "1737km", "192km", "3091km"] },
            H: { slots: ["2083km", "2432km", "2369km", "2501km"] },
            I: { slots: ["573km", "554km", "981km", "595km"] },
            J: { slots: ["4843km", "729km", "2382km", "3101km"] },
            K: { slots: ["3726km", "1128km", "2835km", "2755km"] },
            L: { slots: ["554km", "1131km", "2483km", "2791km"] }
        };

        // --- Nerfed & Balanced Pots Data ---
        const pots = {
            pot1: [
                { name: "스페인", nameEn: "Spain", conf: "UEFA", rank: 1, elo: 2171, delta: -6, code: "es", tier: "S", stars: 1, fixedGroup: 6 }, 
                { name: "아르헨티나", nameEn: "Argentina", conf: "CONMEBOL", rank: 2, elo: 2113, delta: 5, code: "ar", tier: "S", stars: 3, fixedGroup: 11 },
                { name: "프랑스", nameEn: "France", conf: "UEFA", rank: 3, elo: 2062, delta: 7, code: "fr", tier: "S", stars: 2, fixedGroup: 4 },
                { name: "잉글랜드", nameEn: "England", conf: "UEFA", rank: 4, elo: 2042, delta: 36, code: "gb-eng", tier: "S", stars: 1, fixedGroup: 2 },
                { name: "브라질", nameEn: "Brazil", conf: "CONMEBOL", rank: 5, elo: 1978, delta: -18, code: "br", tier: "S", stars: 5 },
                { name: "포르투갈", nameEn: "Portugal", conf: "UEFA", rank: 6, elo: 1976, delta: -17, code: "pt", tier: "A", stars: 0 },
                { name: "네덜란드", nameEn: "Netherlands", conf: "UEFA", rank: 7, elo: 1959, delta: 21, code: "nl", tier: "A", stars: 0 },
                { name: "벨기에", nameEn: "Belgium", conf: "UEFA", rank: 8, elo: 1849, delta: -1, code: "be", tier: "A", stars: 0 },
                { name: "독일", nameEn: "Germany", conf: "UEFA", rank: 9, elo: 1910, delta: -61, code: "de", tier: "S", stars: 4 },
                { name: "멕시코", nameEn: "Mexico", conf: "CONCACAF", host: true, fixedGroup: 0, rank: 15, elo: 1835, delta: 66, code: "mx", tier: "B", stars: 0 },
                { name: "미국", nameEn: "USA", conf: "CONCACAF", host: true, fixedGroup: 3, rank: 18, elo: 1747, delta: -12, code: "us", tier: "B", stars: 0 },
                { name: "캐나다", nameEn: "Canada", conf: "CONCACAF", host: true, fixedGroup: 1, rank: 35, elo: 1802, delta: 11, code: "ca", tier: "B", stars: 0 }
            ],
            pot2: [
                { name: "크로아티아", nameEn: "Croatia", conf: "UEFA", rank: 10, elo: 1933, delta: 47, code: "hr", tier: "A", stars: 0 },
                { name: "모로코", nameEn: "Morocco", conf: "CAF", rank: 11, elo: 1828, delta: 26, code: "ma", tier: "A", stars: 0 },
                { name: "콜롬비아", nameEn: "Colombia", conf: "CONMEBOL", rank: 12, elo: 1950, delta: 10, code: "co", tier: "A", stars: 0 }, // Nerfed: Elo 1998->1950, Delta 21->10
                { name: "우루과이", nameEn: "Uruguay", conf: "CONMEBOL", rank: 14, elo: 1890, delta: -58, code: "uy", tier: "A", stars: 2 },
                { name: "일본", nameEn: "Japan", conf: "AFC", rank: 16, elo: 1878, delta: -35, code: "jp", tier: "B", stars: 0 }, 
                { name: "스위스", nameEn: "Switzerland", conf: "UEFA", rank: 17, elo: 1897, delta: 40, code: "ch", tier: "B", stars: 0 }, // Nerfed: Delta 83->40
                { name: "세네갈", nameEn: "Senegal", conf: "CAF", rank: 19, elo: 1803, delta: 33, code: "sn", tier: "B", stars: 0 },
                { name: "이란", nameEn: "Iran", conf: "AFC", rank: 20, elo: 1754, delta: -83, code: "ir", tier: "B", stars: 0 },
                { name: "대한민국", nameEn: "South Korea", conf: "AFC", rank: 22, elo: 1784, delta: 10, code: "kr", tier: "C", stars: 0 }, 
                { name: "오스트리아", nameEn: "Austria", conf: "UEFA", rank: 23, elo: 1818, delta: -53, code: "at", tier: "B", stars: 0 }, 
                { name: "에콰도르", nameEn: "Ecuador", conf: "CONMEBOL", rank: 24, elo: 1933, delta: 23, code: "ec", tier: "B", stars: 0 },
                { name: "호주", nameEn: "Australia", conf: "AFC", rank: 25, elo: 1774, delta: 55, code: "au", tier: "C", stars: 0 }        
            ],
            pot3: [
                { name: "노르웨이", nameEn: "Norway", conf: "UEFA", rank: 29, elo: 1922, delta: 45, code: "no", tier: "A", buff: true }, // Nerfed: Delta 116->45
                { name: "파나마", nameEn: "Panama", conf: "CONCACAF", rank: 30, elo: 1742, delta: 16, code: "pa", tier: "C" },
                { name: "이집트", nameEn: "Egypt", conf: "CAF", rank: 34, elo: 1645, delta: -12, code: "eg", tier: "C" },
                { name: "알제리", nameEn: "Algeria", conf: "CAF", rank: 35, elo: 1718, delta: 33, code: "dz", tier: "C" },
                { name: "스코틀랜드", nameEn: "Scotland", conf: "UEFA", rank: 36, elo: 1790, delta: 31, code: "gb-sct", tier: "C" },
                { name: "파라과이", nameEn: "Paraguay", conf: "CONMEBOL", rank: 39, elo: 1833, delta: 58, code: "py", tier: "C" },
                { name: "튀니지", nameEn: "Tunisia", conf: "CAF", rank: 40, elo: 1650, delta: 52, code: "tn", tier: "C" },
                { name: "코트디부아르", nameEn: "Ivory Coast", conf: "CAF", rank: 42, elo: 1607, delta: 28, code: "ci", tier: "C" },
                { name: "우즈베키스탄", nameEn: "Uzbekistan", conf: "AFC", rank: 50, elo: 1735, delta: 50, code: "uz", tier: "D" }, 
                { name: "카타르", nameEn: "Qatar", conf: "AFC", rank: 51, elo: 1488, delta: -65, code: "qa", tier: "C" },       
                { name: "사우디아라비아", nameEn: "Saudi Arabia", conf: "AFC", rank: 60, elo: 1578, delta: 42, code: "sa", tier: "C" }, 
                { name: "남아공", nameEn: "South Africa", conf: "CAF", rank: 61, elo: 1530, delta: -46, code: "za", tier: "D" }        
            ],
            pot4: [
                { name: "이탈리아", nameEn: "Italy", conf: "UEFA", rank: 12, elo: 1859, delta: -71, code: "it", tier: "A", stars: 4 }, 
                { name: "덴마크", nameEn: "Denmark", conf: "UEFA", rank: 21, elo: 1864, delta: 8, code: "dk", tier: "B" },   
                { name: "튀르키예", nameEn: "Turkey", conf: "UEFA", rank: 25, elo: 1880, delta: 40, code: "tr", tier: "B" }, // Nerfed: Delta 106->40
                { name: "우크라이나", nameEn: "Ukraine", conf: "UEFA", rank: 28, elo: 1802, delta: 0, code: "ua", tier: "C" },
                { name: "콩고민주공화국", nameEn: "DR Congo", conf: "CAF", rank: 56, elo: 1616, delta: 75, code: "cd", tier: "D" }, 
                { name: "이라크", nameEn: "Iraq", conf: "AFC", rank: 58, elo: 1597, delta: -70, code: "iq", tier: "D" },        
                { name: "요르단", nameEn: "Jordan", conf: "AFC", rank: 66, elo: 1610, delta: -8, code: "jo", tier: "D" },
                { name: "카보베르데", nameEn: "Cape Verde", conf: "CAF", rank: 68, elo: 1560, delta: 89, code: "cv", tier: "D" },
                { name: "가나", nameEn: "Ghana", conf: "CAF", rank: 72, elo: 1509, delta: 80, code: "gh", tier: "C" },
                { name: "퀴라소", nameEn: "Curacao", conf: "CONCACAF", rank: 82, elo: 1467, delta: 131, code: "cw", tier: "D" },
                { name: "아이티", nameEn: "Haiti", conf: "CONCACAF", rank: 84, elo: 1542, delta: 4, code: "ht", tier: "D" },
                { name: "뉴질랜드", nameEn: "New Zealand", conf: "OFC", rank: 86, elo: 1586, delta: 2, code: "nz", tier: "D" }
            ]
        };

        // Async Helpers
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        function getTeamName(team) { return currentLang === 'en' ? (team.nameEn || team.name) : team.name; }

        function toggleLanguage() {
            currentLang = currentLang === 'ko' ? 'en' : 'ko';
            const btn = document.getElementById('langBtn');
            btn.innerHTML = currentLang === 'ko' ? '<i class="fas fa-globe mr-2"></i>Language: EN' : '<i class="fas fa-globe mr-2"></i>Language: KR';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(translations[currentLang][key]) el.innerText = translations[currentLang][key];
            });
            const headerTitle = document.querySelector('h1[data-key="title"]');
            if(headerTitle) headerTitle.innerText = translations[currentLang].title;
            populateCountrySelect();
            if(liveDrawState.active) {
                liveDrawState.groups.forEach((group, idx) => {
                    const ul = document.getElementById(`group-${groupNames[idx]}-list`);
                    if(ul) {
                        Array.from(ul.children).forEach((li, tIdx) => {
                             if(!li.classList.contains('text-slate-500')) li.innerHTML = `<img src="https://flagcdn.com/w40/${group[tIdx].code}.png" class="flag-icon mr-2"> ${getTeamName(group[tIdx])}`;
                        });
                    }
                });
                updateLeagueTableDisplay(); updateHappinessCircuit();
            }
            if(tournamentState.active) renderBracket();
        }

        function populateCountrySelect() {
            const select = document.getElementById('targetCountrySelect');
            const simSelect = document.getElementById('simTargetSelect');
            const allTeams = [...pots.pot1, ...pots.pot2, ...pots.pot3, ...pots.pot4];
            allTeams.sort((a,b) => getTeamName(a).localeCompare(getTeamName(b)));
            
            [select, simSelect].forEach(sel => {
                if(!sel) return;
                sel.innerHTML = '';
                allTeams.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.code; opt.text = getTeamName(t);
                    if(sel === select && t.code === targetTeamCode) opt.selected = true;
                    if(sel === simSelect && t.code === simTargetCode) opt.selected = true;
                    sel.appendChild(opt);
                });
            });
            
            const simSel = document.getElementById('simTargetSelect');
            if(simSel) simSel.onchange = (e) => simTargetCode = e.target.value;
        }

        function changeTargetTeam(code) {
            targetTeamCode = code;
            updateHappinessCircuit(); updateLeagueTableDisplay();
            if(tournamentState.active) renderBracket();
        }

        // Updated Function: Accepts Team Objects to apply Delta (Form)
        function getExpectedScore(tA, tB, isTournament = false) {
            // Apply 1-Year Delta as a "Form" Bonus/Penalty to Elo
            const formMultiplier = isTournament ? 1.3 : 1.5;

            let formA = tA.delta || 0;
            let formB = tB.delta || 0;

            if(formA > 50) formA = 50 + (formA - 50) * 0.5;
            if(formB > 50) formB = 50 + (formB - 50) * 0.5;
            
            const effectiveEloA = tA.elo + (formA * formMultiplier);
            const effectiveEloB = tB.elo + (formB * formMultiplier);

            const eloDiff = effectiveEloA - effectiveEloB;
            
            const winProbA = 1 / (1 + Math.pow(10, (-eloDiff / 400)));
            let baseGoals = isTournament ? 2.2 : 2.6; 
            if (Math.abs(eloDiff) > 400) baseGoals += 1.0; 
            
            let lambdaA = baseGoals * winProbA * (0.5 + Math.random());
            let lambdaB = baseGoals * (1 - winProbA) * (0.5 + Math.random());
            
            const poisson = (lambda) => { let L = Math.exp(-lambda), p = 1.0, k = 0; do { k++; p *= Math.random(); } while (p > L); return k - 1; };
            return { a: poisson(lambdaA), b: poisson(lambdaB) };
        }

        function initGrid() {
            const grid = document.getElementById('groupsGrid');
            if(!grid) return;
            grid.innerHTML = '';
            groupNames.forEach(name => {
                const groupDiv = document.createElement('div');
                groupDiv.id = `group-card-${name}`;
                groupDiv.className = 'group-card rounded-lg p-3 md:p-4 flex flex-col h-full relative';
                
                const logistic = groupLogistics[name];

                groupDiv.innerHTML = `<div class="border-b border-slate-600 pb-2 mb-2 flex justify-between items-center"><span class="text-lg md:text-xl font-black text-white italic">GROUP ${name}</span></div>
                <div class="flex-grow" id="group-${name}-content"><ul class="space-y-2" id="group-${name}-list"></ul></div>`;
                
                const ul = groupDiv.querySelector('ul');
                for(let i=1; i<=4; i++) ul.innerHTML += `<li class="h-9 bg-slate-700/30 rounded border border-slate-700/30 flex items-center px-3 text-xs text-slate-500">POT ${i}</li>`;
                grid.appendChild(groupDiv);
            });
        }

        function createTeamElement(team) {
            const li = document.createElement('li');
            li.className = "h-9 bg-slate-800 rounded border border-slate-600 flex items-center px-3 text-sm font-bold text-white shadow-sm animate-[fadeIn_0.5s_ease-out]";
            li.innerHTML = `<img src="https://flagcdn.com/w40/${team.code}.png" class="flag-icon mr-2"> ${getTeamName(team)}`;
            if(team.code === targetTeamCode) li.classList.add('team-highlight');
            return li;
        }

        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        function solveBipartite(groups, teams, groupIndices, futureUEFA = 0) {
            if (teams.length === 0) return true;
            let team = teams[0]; let remainingTeams = teams.slice(1);
            if (team.conf === 'UEFA') {
                groupIndices.sort((a, b) => {
                    const uefaA = groups[a].filter(t => t.conf === 'UEFA').length;
                    const uefaB = groups[b].filter(t => t.conf === 'UEFA').length;
                    return uefaA - uefaB;
                });
            } else { shuffle(groupIndices); }

            for (let i = 0; i < groupIndices.length; i++) {
                let gIdx = groupIndices[i];
                const confCounts = {}; groups[gIdx].forEach(t => { confCounts[t.conf] = (confCounts[t.conf] || 0) + 1; });
                let isValid = true;
                
                if (team.conf === 'UEFA') { 
                    if ((confCounts['UEFA'] || 0) >= 2) isValid = false; 
                    if (isValid && (confCounts['UEFA'] || 0) > 0) {
                        const groupsWithZeroUEFA = groups.filter(g => !g.some(t => t.conf === 'UEFA')).length;
                        const currentPotUEFA = teams.filter(t => t.conf === 'UEFA').length;
                        const totalAvailableUEFA = currentPotUEFA + futureUEFA;
                        if (totalAvailableUEFA <= groupsWithZeroUEFA) isValid = false;
                    }
                } else { 
                    if ((confCounts[team.conf] || 0) >= 1) isValid = false; 
                }

                if (isValid && team.code === 'iq') {
                    if ((confCounts['CONMEBOL'] || 0) > 0 || (confCounts['CONCACAF'] || 0) > 0) isValid = false;
                }
                
                if (isValid) {
                    groups[gIdx].push(team);
                    let remainingIndices = groupIndices.filter(val => val !== gIdx);
                    if (solveBipartite(groups, remainingTeams, remainingIndices, futureUEFA)) return true;
                    groups[gIdx].pop();
                }
            }
            return false;
        }

        function generateOneSimulation() {
            let simGroups = Array(12).fill(null).map(() => []);
            const deepCopyPot = (potArr) => potArr.map(t => ({...t}));
            const countUEFA = (arr) => arr.filter(t => t.conf === 'UEFA').length;

            let pot1 = deepCopyPot(pots.pot1);
            let fixedHosts = pot1.filter(t => t.fixedGroup !== undefined);
            let randomPot1 = pot1.filter(t => t.fixedGroup === undefined);
            fixedHosts.forEach(host => simGroups[host.fixedGroup].push(host));
            randomPot1 = shuffle(randomPot1);
            let emptyGroupIndices = [];
            for (let i=0; i<12; i++) { if (simGroups[i].length === 0) emptyGroupIndices.push(i); }
            for (let i=0; i<randomPot1.length; i++) { simGroups[emptyGroupIndices[i]].push(randomPot1[i]); }
            
            const uefaP2 = countUEFA(pots.pot2);
            const uefaP3 = countUEFA(pots.pot3);
            const uefaP4 = countUEFA(pots.pot4);

            const fillPot = (potName, futureUEFAVal) => {
                let teams = shuffle(deepCopyPot(pots[potName]));
                if(potName === 'pot4') {
                    teams.sort((a,b) => (a.code === 'iq' ? -1 : b.code === 'iq' ? 1 : 0));
                }

                let availableGroupIndices = [0,1,2,3,4,5,6,7,8,9,10,11];
                if (!solveBipartite(simGroups, teams, availableGroupIndices, futureUEFAVal)) throw new Error("Deadlock");
            };
            
            fillPot('pot2', uefaP3 + uefaP4); 
            fillPot('pot3', uefaP4); 
            fillPot('pot4', 0);

            simGroups.forEach(g => g.forEach(t => { t.pts = 0; t.gf = 0; t.ga = 0; t.gd = 0; t.played = 0; }));
            return simGroups;
        }
        
        function generateSchedule(groups) {
            const schedule = [[], [], []]; 
            groups.forEach((group, gIdx) => {
                schedule[0].push({ gIdx, t1: group[0], t2: group[1], played: false, score: null });
                schedule[0].push({ gIdx, t1: group[2], t2: group[3], played: false, score: null });
                schedule[1].push({ gIdx, t1: group[0], t2: group[2], played: false, score: null });
                schedule[1].push({ gIdx, t1: group[1], t2: group[3], played: false, score: null });
                schedule[2].push({ gIdx, t1: group[0], t2: group[3], played: false, score: null });
                schedule[2].push({ gIdx, t1: group[1], t2: group[2], played: false, score: null });
            });
            return schedule;
        }

        // --- WEIGHTED PK LOGIC v3 ---
        function simulatePK(teamA, teamB) {
            // Outcomes based on provided distribution
            // High Freq: 4-3, 4-2, 5-4
            // Mid Freq: 3-2, 3-1, 5-3, 6-5, 4-1, 7-6, 3-0
            // Low Freq: 8-7, 2-1, 9-8, 2-0, 10-9, 11-10, 12-11, 13-12, 14-13, 1-0
            
            const scenarios = [
                { w: 4, l: 3, weight: 25 }, // 4-3 (Highest)
                { w: 4, l: 2, weight: 20 }, // 4-2
                { w: 5, l: 4, weight: 15 }, // 5-4
                { w: 3, l: 2, weight: 8 },
                { w: 3, l: 1, weight: 6 },
                { w: 5, l: 3, weight: 6 },
                { w: 6, l: 5, weight: 5 }, // Sudden Death Start
                { w: 4, l: 1, weight: 4 },
                { w: 7, l: 6, weight: 3 },
                { w: 3, l: 0, weight: 3 },
                { w: 8, l: 7, weight: 2 },
                { w: 2, l: 1, weight: 1 },
                { w: 9, l: 8, weight: 1 },
                { w: 2, l: 0, weight: 0.5 },
                { w: 10, l: 9, weight: 0.5 }
            ];

            // Weighted Random Selection
            let totalWeight = scenarios.reduce((sum, s) => sum + s.weight, 0);
            let rand = Math.random() * totalWeight;
            let chosen = scenarios[0];
            for(let s of scenarios) {
                if(rand < s.weight) { chosen = s; break; }
                rand -= s.weight;
            }

            // Determine Winner
            // Elo based probability
            const winProbA = 0.5 + ((teamA.elo - teamB.elo) * 0.0005);
            let winner = Math.random() < winProbA ? teamA : teamB;
            let scoreA = winner === teamA ? chosen.w : chosen.l;
            let scoreB = winner === teamB ? chosen.w : chosen.l;

            // Generate Kicks Sequence to Match Score
            let kicksA = [];
            let kicksB = [];

            // Fill with O's based on score
            for(let i=0; i<scoreA; i++) kicksA.push('O');
            for(let i=0; i<scoreB; i++) kicksB.push('O');

            // Calculate Misses (X) needed
            const targetScoreW = chosen.w;
            const targetScoreL = chosen.l;

            let finalKicksW = [];
            let finalKicksL = [];

            if (targetScoreW <= 5) {
                // Fill O's
                for(let i=0; i<targetScoreW; i++) finalKicksW.push('O');
                for(let i=0; i<targetScoreL; i++) finalKicksL.push('O');
                // Fill X's to reach realistic kick count (usually 4 or 5)
                let rounds = 5;
                if (targetScoreW === 3 && targetScoreL === 0) rounds = 3; 
                else if (targetScoreW === 3 && targetScoreL === 1) rounds = 4;
                
                while(finalKicksW.length < rounds) finalKicksW.push('X');
                while(finalKicksL.length < rounds) finalKicksL.push('X');
                
                shuffle(finalKicksW);
                shuffle(finalKicksL);
            } else {
                // Sudden Death (>5)
                // First 5 must be tie. Let's say 4-4 or 5-5.
                let tieScore = 4; // Common tie
                if (Math.random() > 0.5) tieScore = 5;
                
                for(let i=0; i<tieScore; i++) { finalKicksW.push('O'); finalKicksL.push('O'); }
                while(finalKicksW.length < 5) { finalKicksW.push('X'); finalKicksL.push('X'); }
                shuffle(finalKicksW); shuffle(finalKicksL);

                // Add sudden death kicks (Winner O, Loser O ... until Winner O, Loser X)
                let extra = targetScoreW - tieScore;
                for(let i=0; i<extra-1; i++) { finalKicksW.push('O'); finalKicksL.push('O'); }
                finalKicksW.push('O'); finalKicksL.push('X'); // The deciding kick
            }

            // Assign to A/B
            if (winner === teamA) {
                kicksA = finalKicksW; kicksB = finalKicksL;
            } else {
                kicksA = finalKicksL; kicksB = finalKicksW;
            }

            return { scoreA, scoreB, kicksA, kicksB, winner, rounds: kicksA.length };
        }

        async function playScoreAnimation(node, result) {
            const scoreAEl = node.querySelectorAll('.score-display')[0];
            const scoreBEl = node.querySelectorAll('.score-display')[1];
            
            const finalA = result.scoreA;
            const finalB = result.scoreB;

            node.classList.add('live-match');

            const maxScore = Math.max(finalA, finalB);
            if (maxScore > 0) {
                let currA = 0; let currB = 0;
                while(currA < finalA || currB < finalB) {
                    if(currA < finalA && currB < finalB) { if(Math.random() > 0.5) currA++; else currB++; } 
                    else if(currA < finalA) currA++; else currB++;
                    scoreAEl.innerText = currA; scoreBEl.innerText = currB;
                    scoreAEl.classList.add('goal-scored'); setTimeout(() => scoreAEl.classList.remove('goal-scored'), 200);
                    scoreBEl.classList.add('goal-scored'); setTimeout(() => scoreBEl.classList.remove('goal-scored'), 200);
                    await sleep(300 + Math.random()*200);
                }
            }
            scoreAEl.innerText = finalA; scoreBEl.innerText = finalB;

            if (result.isPK) {
                let pkDisplay = node.querySelector('.pk-display');
                if(!pkDisplay) {
                    pkDisplay = document.createElement('div');
                    pkDisplay.className = 'pk-display';
                    node.appendChild(pkDisplay);
                }
                
                pkDisplay.innerText = "PK...";
                await sleep(600);

                const { kicksA, kicksB, pkA, pkB } = result;

                // --- VISUAL FIX: Always slice first 5 kicks ---
                let displayKicksA = kicksA.slice(0, 5);
                let displayKicksB = kicksB.slice(0, 5);
                
                let html = `<span class="${pkA > pkB ? 'text-yellow-400' : 'text-slate-400'} tracking-widest mr-2 flex gap-1">`;
                displayKicksA.forEach(k => html += k === 'O' ? '<span class="pk-o">O</span>' : '<span class="pk-x">X</span>');
                
                html += `</span> <span class="text-white mx-1 text-[10px] font-mono border border-slate-600 px-1 rounded bg-slate-800">${pkA}:${pkB}</span> <span class="${pkB > pkA ? 'text-yellow-400' : 'text-slate-400'} tracking-widest ml-2 flex gap-1">`;
                
                displayKicksB.forEach(k => html += k === 'O' ? '<span class="pk-o">O</span>' : '<span class="pk-x">X</span>');
                html += `</span>`;
                pkDisplay.innerHTML = html;
            } 
            else if (result.isET) {
                let pkDisplay = node.querySelector('.pk-display');
                if(!pkDisplay) { pkDisplay = document.createElement('div'); pkDisplay.className = 'pk-display'; node.appendChild(pkDisplay); }
                pkDisplay.innerText = "(ET)";
            }

            node.classList.remove('live-match');
        }

        function simulateLeagueRound() {
            if(liveDrawState.currentLeagueRound >= 3) return;
            const roundIdx = liveDrawState.currentLeagueRound;
            const matches = liveDrawState.groupSchedule[roundIdx];
            matches.forEach(m => {
                const res = getExpectedScore(m.t1, m.t2, false);
                m.t1.played++; m.t2.played++;
                m.t1.gf += res.a; m.t1.ga += res.b; m.t1.gd += (res.a - res.b);
                m.t2.gf += res.b; m.t2.ga += res.a; m.t2.gd += (res.b - res.a);
                if(res.a > res.b) m.t1.pts += 3; else if (res.a < res.b) m.t2.pts += 3; else { m.t1.pts += 1; m.t2.pts += 1; }
                m.played = true; m.score = { a: res.a, b: res.b };
            });
            liveDrawState.currentLeagueRound++;
            document.getElementById('leagueStatusText').innerText = liveDrawState.currentLeagueRound < 3 ? `Round ${liveDrawState.currentLeagueRound} Finished` : "Group Stage Finished";
            if(liveDrawState.currentLeagueRound === 3) {
                document.getElementById('leagueNextBtn').classList.add('hidden');
                document.getElementById('toTournamentBtn').classList.remove('hidden');
            }
            updateLeagueTableDisplay();
        }

        function toggleWidget() {
            const widget = document.getElementById('happinessWidget');
            const btn = document.getElementById('widgetToggle');
            if(widget && btn) { widget.classList.toggle('active'); btn.classList.toggle('open'); }
        }

        function updateLeagueTableDisplay() {
            let allThirds = [];
            liveDrawState.groups.forEach((group) => {
                const sorted = [...group].sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
                sorted[2].isBestThird = false; allThirds.push(sorted[2]); 
            });
            allThirds.sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
            for(let i=0; i<8; i++) allThirds[i].isBestThird = true;

            liveDrawState.groups.forEach((group, gIdx) => {
                const name = groupNames[gIdx];
                const container = document.getElementById(`group-${name}-content`);
                if(!container) return;
                const sorted = [...group].sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
                let html = `<table class="w-full text-xs text-left league-table"><thead><tr class="border-b border-slate-700"><th>${translations[currentLang].tableTeam}</th><th class="text-center">G</th><th class="text-center">${translations[currentLang].tablePts}</th><th class="text-center">+/-</th></tr></thead><tbody class="divide-y divide-slate-700">`;
                sorted.forEach((t, idx) => {
                    let rankClass = "";
                    if (liveDrawState.currentLeagueRound === 3) {
                        if(idx < 2) rankClass = "qualify-zone"; 
                        else if (idx === 2) { rankClass = t.isBestThird ? "wildcard-zone" : "eliminate-zone"; }
                        else rankClass = "eliminate-zone"; 
                    }
                    const highlight = t.code === targetTeamCode ? "team-highlight" : "";
                    
                    let originalPotIdx = 0;
                    if (pots.pot1.some(p => p.code === t.code)) originalPotIdx = 0;
                    else if (pots.pot2.some(p => p.code === t.code)) originalPotIdx = 1;
                    else if (pots.pot3.some(p => p.code === t.code)) originalPotIdx = 2;
                    else originalPotIdx = 3;

                    const slotInfo = groupLogistics[name] ? groupLogistics[name].slots[originalPotIdx] : "";

                    html += `<tr class="${rankClass} ${highlight}">
                        <td class="flex items-center gap-1 relative">
                            <img src="https://flagcdn.com/w20/${t.code}.png" class="w-4 h-3 rounded-[1px]">
                            <span class="truncate max-w-[80px]">${getTeamName(t)}</span>
                            <div class="tooltip ml-1 cursor-help text-slate-400"><i class="fas fa-plane"></i>
                                <span class="tooltiptext bg-slate-800 border border-slate-600 text-white text-[10px] rounded p-1 shadow-lg">
                                    ${slotInfo}
                                </span>
                            </div>
                        </td>
                        <td class="text-center opacity-60">${t.played}</td>
                        <td class="text-center font-bold">${t.pts}</td>
                        <td class="text-center opacity-60">${t.gd>0?'+'+t.gd:t.gd}</td>
                    </tr>`;
                });
                container.innerHTML = html + `</tbody></table>`;
            });
            updateThirdPlaceRanking(allThirds); updateHappinessCircuit();
        }

        function updateThirdPlaceRanking() {
            let displayList = [];
             liveDrawState.groups.forEach((group, gIdx) => {
                const sorted = [...group].sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
                displayList.push({ team: sorted[2], groupName: groupNames[gIdx] });
            });
            displayList.sort((a,b) => b.team.pts - a.team.pts || b.team.gd - a.team.gd || b.team.gf - a.team.gf || a.team.rank - b.team.rank);
            const tbody = document.getElementById('thirdPlaceBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            displayList.forEach((item, idx) => {
                const t = item.team;
                const style = idx < 8 ? "text-white border-l-4 border-emerald-500 bg-emerald-500/10 font-bold" : "text-slate-500 opacity-50 border-l-4 border-transparent line-through decoration-slate-600";
                const nameClass = t.code === targetTeamCode ? "team-highlight" : "";
                tbody.innerHTML += `<tr class="${style} border-b border-slate-800 last:border-0"><td class="p-1 text-center text-xs">${idx+1}</td><td class="p-1 flex items-center gap-1 ${nameClass}"><span class="text-[9px] bg-slate-800 px-1 rounded text-slate-400 w-4 text-center">${item.groupName}</span><span class="truncate w-24">${getTeamName(t)}</span></td><td class="p-1 text-center font-mono text-xs font-bold">${t.pts}</td><td class="p-1 text-center font-mono text-xs">${t.gd>0?'+'+t.gd:t.gd}</td></tr>`;
            });
        }

        function updateHappinessCircuit() {
            let targetGroupIndex = -1;
            for(let i=0; i<12; i++) { if(liveDrawState.groups[i].some(t => t.code === targetTeamCode)) targetGroupIndex = i; }
            const historyDiv = document.getElementById('targetGroupMatches');
            document.getElementById('probFlag').src = `https://flagcdn.com/w20/${targetTeamCode}.png`;
            if(targetGroupIndex === -1) {
                if(historyDiv) historyDiv.innerHTML = `<div class="text-xs text-slate-600 text-center italic py-4">${translations[currentLang].scheduleEmpty}</div>`;
                document.getElementById('probText').innerText = "--%";
                document.getElementById('probBar').style.width = "0%";
                return;
            }
            const targetGroup = liveDrawState.groups[targetGroupIndex];
            if(historyDiv) {
                historyDiv.innerHTML = '';
                liveDrawState.groupSchedule.forEach((roundMatches) => {
                    roundMatches.filter(m => m.gIdx === targetGroupIndex).forEach(m => {
                        const div = document.createElement('div');
                        div.className = "text-xs text-slate-300 mb-1 pb-1 border-b border-slate-700 last:border-0 flex justify-between items-center";
                        let leftClass = m.t1.code === targetTeamCode ? "team-highlight" : "";
                        let rightClass = m.t2.code === targetTeamCode ? "team-highlight" : "";
                        let scoreContent = m.played ? `<span class="text-emerald-400 font-mono font-bold text-sm">${m.score.a} : ${m.score.b}</span>` : `<span class="text-slate-500 text-[10px] bg-slate-800 px-1 rounded">VS</span>`;
                        div.innerHTML = `<div class="w-1/3 text-right truncate ${leftClass}">${getTeamName(m.t1)}</div><div class="w-1/3 text-center">${scoreContent}</div><div class="w-1/3 text-left truncate ${rightClass}">${getTeamName(m.t2)}</div>`;
                        historyDiv.appendChild(div);
                    });
                });
            }
            let prob = 0;
            if (liveDrawState.currentLeagueRound === 3) document.getElementById('probSection').classList.add('hidden');
            else {
                document.getElementById('probSection').classList.remove('hidden');
                prob = calculateTargetProb(targetGroup, liveDrawState.currentLeagueRound);
                document.getElementById('probText').innerText = `${prob}%`;
                const pb = document.getElementById('probBar');
                pb.style.width = `${prob}%`;
                pb.className = `h-full rounded-full transition-all duration-700 ${prob < 30 ? 'bg-red-600' : (prob < 60 ? 'bg-yellow-500' : 'bg-emerald-500')}`;
            }
            const widgetBtn = document.getElementById('widgetSimBtn');
            const widgetBtnText = document.getElementById('widgetSimBtnText');
            if(widgetBtn) {
                if(liveDrawState.currentLeagueRound === 3) widgetBtn.classList.add('hidden'); 
                else { widgetBtn.classList.remove('hidden'); if(widgetBtnText) widgetBtnText.innerText = currentLang === 'ko' ? `조별리그 ${liveDrawState.currentLeagueRound + 1}차전 진행` : `Simulate Matchday ${liveDrawState.currentLeagueRound + 1}`; }
            }
        }

        function calculateTargetProb(group, roundNum) {
            const initialGroup = group.map(t => ({...t})); 
            let qualifiedCount = 0; const iterations = 300; 
            for(let i=0; i<iterations; i++) {
                const simGroup = initialGroup.map(t => ({...t})); 
                const runMatch = (idxA, idxB) => {
                    const tA = simGroup[idxA]; const tB = simGroup[idxB];
                    const res = getExpectedScore(tA, tB, false);
                    if(res.a > res.b) tA.pts += 3; else if (res.a < res.b) tB.pts += 3; else { tA.pts += 1; tB.pts += 1; }
                    tA.gd += (res.a - res.b); tB.gd += (res.b - res.a);
                };
                if (roundNum === 0) { runMatch(0,1); runMatch(2,3); runMatch(0,2); runMatch(1,3); runMatch(0,3); runMatch(1,2); }
                else if (roundNum === 1) { runMatch(0,2); runMatch(1,3); runMatch(0,3); runMatch(1,2); }
                else if (roundNum === 2) { runMatch(0,3); runMatch(1,2); }
                simGroup.sort((a,b) => b.pts - a.pts || b.gd - a.gd);
                const rank = simGroup.findIndex(t => t.code === targetTeamCode);
                if (rank < 2) qualifiedCount++; else if (rank === 2) { if(simGroup[rank].pts >= 4) qualifiedCount++; else if(simGroup[rank].pts === 3) qualifiedCount += 0.6; }
            }
            return Math.round((qualifiedCount / iterations) * 100);
        }

        function toggleR32() { const col = document.getElementById('col-r32'); const btn = document.getElementById('r32CollapseBtn'); if(col) { col.classList.toggle('collapsed'); btn.innerHTML = col.classList.contains('collapsed') ? `<i class="fas fa-chevron-right mr-1"></i>${translations[currentLang].expand32}` : `<i class="fas fa-chevron-left mr-1"></i>${translations[currentLang].collapse32}`; } }
        function updateTournamentStatus() { const statusDiv = document.getElementById('tournamentStatusText'); if(!tournamentState.active) { if(statusDiv) statusDiv.innerText = "Finished"; return; } statusDiv.innerText = `${tournamentState.rounds[tournamentState.currentRoundIndex].name} - Match ${tournamentState.currentMatchIndex + 1}/${tournamentState.rounds[tournamentState.currentRoundIndex].matches.length}`; }

        async function runNextMatch() {
            if(!tournamentState.active || isMatchAnimating) return;
            isMatchAnimating = true;

            const round = tournamentState.rounds[tournamentState.currentRoundIndex];
            if(tournamentState.currentMatchIndex >= round.matches.length) {
                isMatchAnimating = false;
                return;
            }
            const match = round.matches[tournamentState.currentMatchIndex];
            
            if(!match.p1 || !match.p2) { tournamentState.currentMatchIndex++; isMatchAnimating = false; return; }

            let res = getExpectedScore(match.p1, match.p2, true);
            let scoreA = res.a;
            let scoreB = res.b;
            let isET = false;
            let isPK = false;
            let pkData = null;

            if(scoreA === scoreB) {
                isET = true;
                const eloA = match.p1.elo + ((match.p1.delta || 0) * 1.3);
                const eloB = match.p2.elo + ((match.p2.delta || 0) * 1.3);
                const eloDiff = eloA - eloB;
                const winProbA = 1 / (1 + Math.pow(10, (-eloDiff / 400)));
                const baseGoalsET = 0.7; 
                const lambdaA = baseGoalsET * winProbA * (0.5 + Math.random());
                const lambdaB = baseGoalsET * (1 - winProbA) * (0.5 + Math.random());
                const poisson = (lambda) => { let L = Math.exp(-lambda), p = 1.0, k = 0; do { k++; p *= Math.random(); } while (p > L); return k - 1; };
                scoreA += poisson(lambdaA);
                scoreB += poisson(lambdaB);
            }

            let winner = scoreA > scoreB ? match.p1 : match.p2;
            
            if(scoreA === scoreB) {
                isPK = true;
                pkData = simulatePK(match.p1, match.p2);
                winner = pkData.winner;
            }

            const activeNode = document.querySelector('.match-node.active-match');
            if (activeNode) {
                await playScoreAnimation(activeNode, { scoreA, scoreB, isET, isPK, pkA: pkData?.scoreA, pkB: pkData?.scoreB, kicksA: pkData?.kicksA, kicksB: pkData?.kicksB });
            }

            match.score = `${scoreA} : ${scoreB}`;
            match.pk = isPK ? `(PK ${pkData.scoreA}:${pkData.scoreB})` : (isET ? "(ET)" : "");
            match.winner = winner;

            const id = match.id;
            const setWinner = (nextRoundIdx, matchIdx, playerNum) => {
                if(tournamentState.rounds[nextRoundIdx] && tournamentState.rounds[nextRoundIdx].matches[matchIdx]) {
                    if(playerNum === 1) tournamentState.rounds[nextRoundIdx].matches[matchIdx].p1 = winner;
                    else tournamentState.rounds[nextRoundIdx].matches[matchIdx].p2 = winner;
                }
            };
            if(id==74) setWinner(1,0,1); if(id==77) setWinner(1,0,2); if(id==73) setWinner(1,1,1); if(id==75) setWinner(1,1,2);
            if(id==76) setWinner(1,2,1); if(id==78) setWinner(1,2,2); if(id==79) setWinner(1,3,1); if(id==80) setWinner(1,3,2);
            if(id==83) setWinner(1,4,1); if(id==84) setWinner(1,4,2); if(id==81) setWinner(1,5,1); if(id==82) setWinner(1,5,2);
            if(id==86) setWinner(1,6,1); if(id==88) setWinner(1,6,2); if(id==85) setWinner(1,7,1); if(id==87) setWinner(1,7,2);
            if(id>=89 && id<=96) setWinner(2, Math.floor((id-89)/2), (id-89)%2===0?1:2);
            if(id>=97 && id<=100) setWinner(3, Math.floor((id-97)/2), (id-97)%2===0?1:2);
            if(id>=101 && id<=102) setWinner(4, Math.floor((id-101)/2), (id-101)%2===0?1:2);

            tournamentState.currentMatchIndex++;
            if(tournamentState.currentMatchIndex >= round.matches.length) {
                if(tournamentState.currentRoundIndex < 4) { tournamentState.currentRoundIndex++; tournamentState.currentMatchIndex = 0; }
                else { tournamentState.active = false; document.getElementById('nextMatchBtn').classList.add('hidden'); showWinnerCeremony(winner); }
            }
            renderBracket(); updateTournamentStatus();
            const newActive = document.querySelector('.match-node.active-match'); 
            if(newActive) newActive.scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
            
            isMatchAnimating = false;
        }

        // --- BATCH SIMULATION (DATA CENTER) ---
        async function runBatchSimulation() {
            const reportDiv = document.getElementById('reportResults');
            const loadingDiv = document.getElementById('simLoading');
            reportDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            await sleep(100); // UI render

            const iterations = 100;
            const stats = { winners: {}, nemesis: {}, rounds: { r32:0, r16:0, qf:0, sf:0, final:0, winner:0, groupOut:0 } };
            let targetGroupsCollected = []; // Collect groups containing target

            // Run Monte Carlo
            for(let i=0; i<iterations; i++) {
                // Use CURRENT groups if available, otherwise generate fresh
                // ** DEADLOCK FIX **: Wrap generation in try-catch loop
                let simGroups = null;
                let attempts = 0;
                while(simGroups === null && attempts < 50) {
                    try {
                        if (i === 0 && liveDrawState.groups && liveDrawState.groups.length > 0) {
                             simGroups = JSON.parse(JSON.stringify(liveDrawState.groups));
                        } else {
                             simGroups = generateOneSimulation();
                        }
                    } catch (e) {
                        attempts++; // Retry silently
                    }
                }
                if (!simGroups) continue; // Should not happen with retries, but safe guard

                // 1. Group Stage
                simGroups.forEach(g => {
                    // Find Target Group for Analysis
                    if(g.some(t => t.code === simTargetCode)) {
                        const avg = g.reduce((a,b)=>a+b.elo,0)/4;
                        targetGroupsCollected.push({ avgElo: avg, teams: g, id: groupNames[simGroups.indexOf(g)] });
                    }

                    const matches = [ [0,1], [2,3], [0,2], [1,3], [0,3], [1,2] ];
                    matches.forEach(pair => {
                        const tA = g[pair[0]]; const tB = g[pair[1]];
                        const res = getExpectedScore(tA, tB, false);
                        if(res.a > res.b) tA.pts += 3; else if (res.b > res.a) tB.pts += 3; else { tA.pts++; tB.pts++; }
                        tA.gd += (res.a - res.b); tB.gd += (res.b - res.a);
                    });
                    g.sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.elo - a.elo);
                });

                // 2. Qualifiers
                let qualified = [];
                let thirds = [];
                simGroups.forEach((g, idx) => {
                    qualified.push({...g[0], group: groupNames[idx], pos:1});
                    qualified.push({...g[1], group: groupNames[idx], pos:2});
                    thirds.push({...g[2], group: groupNames[idx], pos:3});
                });
                thirds.sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.elo - a.elo);
                const top8Thirds = thirds.slice(0, 8);
                
                // Check Target Status
                let targetStage = "groupOut";
                let tTeam = null;
                // Find target in simGroups to see result
                for(let g of simGroups) {
                    const found = g.find(t => t.code === simTargetCode);
                    if(found) {
                        tTeam = found;
                        const rank = g.indexOf(found);
                        if(rank < 2) targetStage = "r32";
                        else if (rank === 2) {
                             if(top8Thirds.some(t => t.code === simTargetCode)) targetStage = "r32";
                        }
                    }
                }
                
                // 3. Tournament Sim (Simplified)
                if (targetStage !== "groupOut") {
                    let survivors = [...qualified, ...top8Thirds];
                    // R32 -> R16 -> QF -> SF -> F -> Winner
                    let currentRound = survivors;
                    let roundNames = ["r32", "r16", "qf", "sf", "final", "winner"];
                    
                    for(let r=0; r<5; r++) { // 5 rounds
                        let nextRound = [];
                        currentRound.sort(() => Math.random() - 0.5);
                        
                        for(let k=0; k<currentRound.length; k+=2) {
                            const p1 = currentRound[k]; 
                            const p2 = currentRound[k+1];
                            const res = getExpectedScore(p1, p2, true);
                            let winner = (res.a > res.b) ? p1 : ((res.b > res.a) ? p2 : (Math.random() > 0.5 ? p1 : p2)); 
                            
                            nextRound.push(winner);
                            
                            // Track Nemesis
                            if(p1.code === simTargetCode) {
                                if(winner !== p1) stats.nemesis[p2.name] = (stats.nemesis[p2.name] || 0) + 1;
                            } else if (p2.code === simTargetCode) {
                                if(winner !== p2) stats.nemesis[p1.name] = (stats.nemesis[p1.name] || 0) + 1;
                            }
                        }
                        
                        if(nextRound.find(t => t.code === simTargetCode)) {
                             targetStage = roundNames[r+1];
                        }
                        currentRound = nextRound;
                    }
                    const champ = currentRound[0];
                    stats.winners[champ.name] = (stats.winners[champ.name] || 0) + 1;
                }
                
                stats.rounds[targetStage]++;
            }

            // Render Round Stats
            const rContainer = document.getElementById('roundStatsContainer');
            rContainer.innerHTML = '';
            const orderedKeys = ['groupOut', 'r32', 'r16', 'qf', 'sf', 'final', 'winner'];
            const roundLabels = { groupOut: "조별 탈락", r32: "32강", r16: "16강", qf: "8강", sf: "4강", final: "결승", winner: "우승" };
            const maxVal = Math.max(...Object.values(stats.rounds));
            
            orderedKeys.forEach(key => {
                const count = stats.rounds[key];
                if(count >= 0) { 
                    const percent = (count / iterations * 100).toFixed(0);
                    const width = (count / iterations * 100); 
                    const colorClass = key === 'groupOut' ? 'bg-red-600' : (key === 'winner' ? 'bg-yellow-500' : 'bg-emerald-500');
                    const textClass = key === 'groupOut' ? 'text-red-400 font-bold' : (key === 'winner' ? 'text-yellow-400 font-bold' : 'text-slate-300');
                    
                    rContainer.innerHTML += `
                        <div class="stat-row">
                            <div class="stat-label"><span class="${textClass}">${roundLabels[key]}</span><span>${count}회 (${percent}%)</span></div>
                            <div class="stat-track"><div class="stat-fill ${colorClass}" style="width: ${width}%"></div></div>
                        </div>
                    `;
                }
            });

            // Render Target Specific Group Analysis
            if (targetGroupsCollected.length > 0) {
                targetGroupsCollected.sort((a,b) => b.avgElo - a.avgElo); // Sort Descending Elo
                const worstG = targetGroupsCollected[0]; // Highest Avg Elo
                const bestG = targetGroupsCollected[targetGroupsCollected.length - 1]; // Lowest Avg Elo

                const renderGroupInfo = (g, containerId) => {
                    const div = document.getElementById(containerId);
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-1">
                            <span class="font-bold text-white">Group ${g.id}</span>
                            <span class="text-xs text-slate-400">Avg Elo: ${Math.round(g.avgElo)}</span>
                        </div>
                        <ul class="space-y-1">
                            ${g.teams.map(t => `<li class="flex items-center text-xs ${t.code === simTargetCode ? 'text-yellow-400 font-bold' : 'text-slate-300'}"><img src="https://flagcdn.com/w20/${t.code}.png" class="w-4 h-3 mr-2">${getTeamName(t)}</li>`).join('')}
                        </ul>
                    `;
                };
                renderGroupInfo(worstG, 'worstCaseContent');
                renderGroupInfo(bestG, 'bestCaseContent');
            }

            // Render Top 5 Winners
            const sortedWinners = Object.entries(stats.winners).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const wList = document.getElementById('winnerList');
            wList.innerHTML = '';
            sortedWinners.forEach(([name, count], idx) => {
                 wList.innerHTML += `<li class="flex justify-between items-center bg-slate-900/50 p-2 rounded"><span class="font-bold ${idx===0?'text-yellow-400':'text-slate-300'}">${idx+1}. ${name}</span><span class="text-emerald-400 font-mono">${count}회</span></li>`;
            });

            // Render Nemesis
            const sortedNemesis = Object.entries(stats.nemesis).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const nList = document.getElementById('nemesisList');
            nList.innerHTML = '';
            if(sortedNemesis.length === 0) nList.innerHTML = '<li class="text-center text-slate-500 italic py-2">탈락 기록 없음 (혹은 우승?)</li>';
            else sortedNemesis.forEach(([name, count]) => {
                nList.innerHTML += `<li class="flex justify-between items-center bg-slate-900/50 p-2 rounded"><span class="text-slate-300">${name}</span><span class="text-red-400 font-mono">${count}회</span></li>`;
            });

            loadingDiv.classList.add('hidden');
            reportDiv.classList.remove('hidden');
        }

        function showWinnerCeremony(team) {
            fireConfetti();
            document.getElementById('winnerModal').classList.remove('hidden');
            document.getElementById('winnerFlag').src = `https://flagcdn.com/w640/${team.code}.png`;
            document.getElementById('winnerName').innerText = getTeamName(team);
            const starsContainer = document.getElementById('starsContainer'); starsContainer.innerHTML = '';
            for(let i=0; i<(team.stars||0); i++) { const s = document.createElement('i'); s.className = 'fas fa-star text-yellow-400 text-xl'; starsContainer.appendChild(s); }
        }
        function closeWinnerModal() { document.getElementById('winnerModal').classList.add('hidden'); if(confettiAnimationId) cancelAnimationFrame(confettiAnimationId); const ctx = document.getElementById('confetti-canvas').getContext('2d'); ctx.clearRect(0, 0, window.innerWidth, window.innerHeight); }
        function fireConfetti() { const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d'); canvas.width = window.innerWidth; canvas.height = window.innerHeight; const pieces = []; for(let i=0; i<300; i++) pieces.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height, color: ['#f00', '#0f0', '#00f', '#ff0'][Math.floor(Math.random()*4)], size: Math.random()*10+5 }); function draw() { ctx.clearRect(0, 0, canvas.width, canvas.height); pieces.forEach(p => { ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y+=5, p.size, p.size); if(p.y > canvas.height) p.y = -10; }); confettiAnimationId = requestAnimationFrame(draw); } draw(); }
        function toggleR32() { const col = document.getElementById('col-r32'); const btn = document.getElementById('r32CollapseBtn'); if(col) { col.classList.toggle('collapsed'); btn.innerHTML = col.classList.contains('collapsed') ? `<i class="fas fa-chevron-right mr-1"></i>${translations[currentLang].expand32}` : `<i class="fas fa-chevron-left mr-1"></i>${translations[currentLang].collapse32}`; } }
        function updateTournamentStatus() { const statusDiv = document.getElementById('tournamentStatusText'); if(!tournamentState.active) { if(statusDiv) statusDiv.innerText = "Finished"; return; } statusDiv.innerText = `${tournamentState.rounds[tournamentState.currentRoundIndex].name} - Match ${tournamentState.currentMatchIndex + 1}/${tournamentState.rounds[tournamentState.currentRoundIndex].matches.length}`; }

        function renderBracket() {
            const container = document.getElementById('tournamentBracket'); if(!container) return; let html = '';
            const showCollapse = tournamentState.currentRoundIndex > 0;
            document.getElementById('r32CollapseBtn').classList.remove('hidden', 'block'); document.getElementById('r32CollapseBtn').classList.add(showCollapse ? 'block' : 'hidden');
            tournamentState.rounds.forEach((round, rIdx) => {
                const isR32 = rIdx === 0; const colId = isR32 ? 'col-r32' : `col-r${rIdx}`; const collapsedClass = (isR32 && tournamentState.currentRoundIndex > 0) ? 'collapsed' : '';
                html += `<div id="${colId}" class="round-column ${collapsedClass}"><div class="round-header">${round.name}</div>`;
                round.matches.forEach((match, mIdx) => {
                    const isNext = (rIdx === tournamentState.currentRoundIndex && mIdx === tournamentState.currentMatchIndex);
                    let activeClass = isNext ? "active-match" : (match.winner !== null ? "finished" : "");
                    let p1Class = match.p1 && match.p1.code === targetTeamCode ? "text-yellow-300 font-bold" : "text-white";
                    let p2Class = match.p2 && match.p2.code === targetTeamCode ? "text-yellow-300 font-bold" : "text-white";
                    if(match.winner === match.p1) p1Class += " text-emerald-400"; if(match.winner === match.p2) p2Class += " text-emerald-400";
                    let p1Info = match.p1 && match.p1.group ? `<span class="text-[9px] md:text-xs text-gray-400 ml-1">(${match.p1.rank}위/${match.p1.group}${match.p1.pos})</span>` : "";
                    let p2Info = match.p2 && match.p2.group ? `<span class="text-[9px] md:text-xs text-gray-400 ml-1">(${match.p2.rank}위/${match.p2.group}${match.p2.pos})</span>` : "";
                    html += `<div class="match-node ${activeClass}"><div class="flex justify-between text-[10px] md:text-xs text-slate-500 mb-1"><span>M${match.id}</span><span>${match.venue}</span></div>
                            <div class="team-slot ${match.winner === match.p1 ? 'winner' : ''}"><div class="${p1Class} flex items-center truncate">${match.p1 ? `<img src="https://flagcdn.com/w20/${match.p1.code}.png" class="w-4 h-3 md:w-5 md:h-4 mr-1 inline">` : ''}${match.p1 ? getTeamName(match.p1) : 'TBD'}${p1Info}</div><div class="score-display">${match.score ? match.score.split(':')[0] : ''}</div></div>
                            <div class="team-slot ${match.winner === match.p2 ? 'winner' : ''}"><div class="${p2Class} flex items-center truncate">${match.p2 ? `<img src="https://flagcdn.com/w20/${match.p2.code}.png" class="w-4 h-3 md:w-5 md:h-4 mr-1 inline">` : ''}${match.p2 ? getTeamName(match.p2) : 'TBD'}${p2Info}</div><div class="score-display">${match.score ? match.score.split(':')[1] : ''}</div></div>${match.pk ? `<div class="text-center text-[10px] md:text-xs text-yellow-500 pk-display">${match.pk}</div>` : ''}</div>`;
                }); html += `</div>`;
            }); container.innerHTML = html;
        }

        function switchTab(tabId) {
            // 1. Handle Tab Buttons & Sections
            ['draw', 'tournament', 'report'].forEach(t => { 
                const btn = document.getElementById(`tab-${t}`); 
                const section = document.getElementById(`section-${t}`); 
                if (t === tabId) { 
                    btn.classList.remove('tab-inactive', 'hidden'); 
                    btn.classList.add('tab-active'); 
                    section.classList.remove('hidden'); 
                } else { 
                    btn.classList.remove('tab-active'); 
                    btn.classList.add('tab-inactive'); 
                    section.classList.add('hidden'); 
                } 
            });
            
            const footer = document.getElementById('drawController');
            const initial = document.getElementById('initialControls');
            const toggleBtn = document.getElementById('widgetToggle');
            const widget = document.getElementById('happinessWidget');

            if (tabId === 'report') {
                // Hide ALL controls
                if(footer) footer.style.display = 'none';
                if(initial) initial.style.display = 'none';
                if(toggleBtn) toggleBtn.style.display = 'none';
                if(widget) widget.classList.remove('active');
                if(toggleBtn) toggleBtn.classList.remove('open');
            } 
            else {
                // Logic for Draw/Tournament Tabs
                
                // 1. Determine if we are in "Initial State" or "Running State"
                const isRunning = liveDrawState.active || tournamentState.active;

                if (!isRunning) {
                    // Not started yet -> Show Initial, Hide Footer
                    if(initial) initial.style.display = 'flex'; 
                    if(footer) footer.style.display = 'none';
                    if(toggleBtn) toggleBtn.style.display = 'none';
                } else {
                    // Started -> Show Footer, Hide Initial
                    if(initial) initial.style.display = 'none';
                    if(footer) footer.style.display = 'flex';
                    if(toggleBtn) toggleBtn.style.display = 'flex';
                }

                // 2. Specific Tab Logic
                if(tabId === 'tournament' && tournamentState.active) { 
                    document.getElementById('drawControlsGroup').classList.add('hidden'); 
                    document.getElementById('leagueControlsGroup').classList.add('hidden'); 
                    document.getElementById('tournamentControlsGroup').classList.remove('hidden'); 
                    document.getElementById('tournamentControlsGroup').classList.add('flex'); 
                    
                    if(widget) widget.classList.remove('active');
                    if(toggleBtn) toggleBtn.classList.remove('open');
                }
                else if (tabId === 'draw') { 
                    if(liveDrawState.currentStep >= 48) { 
                        // League Phase
                        document.getElementById('drawControlsGroup').classList.add('hidden'); 
                        document.getElementById('leagueControlsGroup').classList.remove('hidden'); 
                        document.getElementById('leagueControlsGroup').classList.add('flex'); 
                        
                        if(widget && isRunning) widget.classList.add('active');
                        if(toggleBtn && isRunning) {
                            toggleBtn.style.display = 'flex';
                            toggleBtn.classList.add('open');
                        }
                    } else { 
                        // Draw Phase
                        document.getElementById('drawControlsGroup').classList.remove('hidden'); 
                        document.getElementById('leagueControlsGroup').classList.add('hidden'); 
                        document.getElementById('tournamentControlsGroup').classList.add('hidden'); 
                        if(widget) widget.classList.remove('active');
                        if(toggleBtn) toggleBtn.classList.remove('open');
                    } 
                }
            }
        }
        function resetDraw() { location.reload(); }
        
        // Re-declare missing functions
        function startLiveDraw() {
            if(isDrawing) return;
            initGrid();
            let success = false, attempts = 0, finalGroups = [];
            while (!success && attempts < 1000) { attempts++; try { finalGroups = generateOneSimulation(); success = true; } catch (e) {} }
            const schedule = generateSchedule(finalGroups);
            liveDrawState = { active: true, groups: finalGroups, currentPot: 0, currentGroupIndex: 0, currentStep: 0, totalSteps: 48, currentLeagueRound: 0, groupSchedule: schedule };
            document.getElementById('initialControls').style.display = 'none';
            document.getElementById('drawController').style.display = 'flex';
            document.getElementById('drawControlsGroup').classList.remove('hidden');
            document.getElementById('leagueControlsGroup').classList.add('hidden');
            document.getElementById('tournamentControlsGroup').classList.add('hidden');
            document.getElementById('happinessWidget').classList.remove('active');
            document.getElementById('widgetToggle').classList.remove('open');
            updateStatusText(); updateHappinessCircuit();
        }

        function startSingleDraw() {
            initGrid();
            let success = false, attempts = 0, finalGroups = [];
            while (!success && attempts < 1000) { attempts++; try { finalGroups = generateOneSimulation(); success = true; } catch (e) {} }
            const schedule = generateSchedule(finalGroups);
            liveDrawState = { active: true, groups: finalGroups, currentPot: 4, currentGroupIndex: 0, currentStep: 48, totalSteps: 48, currentLeagueRound: 0, groupSchedule: schedule };
            document.getElementById('initialControls').style.display = 'none';
            document.getElementById('drawController').style.display = 'flex';
            document.getElementById('drawControlsGroup').classList.add('hidden');
            document.getElementById('leagueControlsGroup').classList.remove('hidden'); document.getElementById('leagueControlsGroup').classList.add('flex');
            
            const widget = document.getElementById('happinessWidget');
            const toggle = document.getElementById('widgetToggle');
            widget.classList.add('active');
            toggle.classList.add('open');

             liveDrawState.groups.forEach((group, idx) => {
                const ul = document.getElementById(`group-${groupNames[idx]}-list`);
                if(ul) { ul.innerHTML = ''; group.forEach(team => ul.appendChild(createTeamElement(team))); }
            });
            updateLeagueTableDisplay();
        }

        function updateStatusText() {
            const pot = liveDrawState.currentPot + 1;
            const group = groupNames[liveDrawState.currentGroupIndex];
            document.getElementById('drawStatusText').innerHTML = `<span class="text-slate-400 font-normal">Next:</span> <span class="text-emerald-400">POT ${pot}</span> <span class="text-white">→ Group ${group}</span>`;
        }

        async function drawNextStep() {
            if(!liveDrawState.active) return;
            const btn = document.getElementById('lotteryBtn'); if(btn) btn.disabled = true;
            const targetTeam = liveDrawState.groups[liveDrawState.currentGroupIndex][liveDrawState.currentPot];
            const groupName = groupNames[liveDrawState.currentGroupIndex];
            await spinLottery(targetTeam, liveDrawState.currentPot + 1);
            const ul = document.getElementById(`group-${groupName}-list`);
            if(ul) {
                const li = createTeamElement(targetTeam);
                const placeholder = ul.children[liveDrawState.currentPot];
                if(placeholder) ul.replaceChild(li, placeholder); else ul.appendChild(li);
            }
            document.getElementById(`group-card-${groupName}`).scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
            
            liveDrawState.currentGroupIndex++;
            if(liveDrawState.currentGroupIndex >= 12) { liveDrawState.currentGroupIndex = 0; liveDrawState.currentPot++; }
            liveDrawState.currentStep++;

            if(liveDrawState.currentStep >= 48) {
                document.getElementById('drawControlsGroup').classList.add('hidden');
                document.getElementById('leagueControlsGroup').classList.remove('hidden'); document.getElementById('leagueControlsGroup').classList.add('flex');
                
                const widget = document.getElementById('happinessWidget');
                const toggle = document.getElementById('widgetToggle');
                widget.classList.add('active');
                toggle.classList.add('open');
                
                updateLeagueTableDisplay(); 
            } else { updateStatusText(); if(btn) btn.disabled = false; }
        }
        
        async function spinLottery(team, pot) {
            const modal = document.getElementById('lotteryModal');
            const title = document.getElementById('lotteryTitle');
            const content = document.getElementById('spinningContent');
            modal.classList.remove('hidden');
            title.innerText = currentLang === 'ko' ? `POT ${pot} 추첨 중...` : `Drawing POT ${pot}...`;
            const candidates = pots[`pot${pot}`]; 
            let count = 0;
            return new Promise(resolve => {
                const interval = setInterval(() => {
                    const rand = candidates[Math.floor(Math.random() * candidates.length)];
                    content.innerHTML = `<img src="https://flagcdn.com/w80/${rand.code}.png" class="w-16 h-10 inline shadow-lg">`;
                    count++;
                    if(count > 8) {
                        clearInterval(interval);
                        content.innerHTML = `<img src="https://flagcdn.com/w160/${team.code}.png" class="w-24 h-16 inline shadow-2xl border-2 border-emerald-400">`;
                        title.innerText = getTeamName(team);
                        title.className = "text-2xl font-black text-emerald-400 mb-2 animate-bounce";
                        setTimeout(() => { modal.classList.add('hidden'); title.className = "text-lg font-bold text-emerald-400 mb-2"; resolve(); }, 800);
                    }
                }, 100);
            });
        }

        function startTournament() {
            if(!liveDrawState.groups || liveDrawState.groups.length === 0) return;
            switchTab('tournament');
            const container = document.getElementById('tournamentBracket');
            document.getElementById('leagueControlsGroup').classList.add('hidden');
            document.getElementById('tournamentControlsGroup').classList.remove('hidden'); document.getElementById('tournamentControlsGroup').classList.add('flex');
            
            const widget = document.getElementById('happinessWidget');
            const toggle = document.getElementById('widgetToggle');
            widget.classList.remove('active');
            toggle.classList.remove('open');

            if(container) container.innerHTML = '<div class="text-center text-emerald-400 py-10"><i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i><br>Generating...</div>';
            setTimeout(() => { initTournamentStructure(); }, 800);
        }

        function initTournamentStructure() {
            // Build Pool of Qualified Teams (Map by Code to ensure uniqueness)
            const qualifiedTeams = new Map();
            const thirdPlaceCandidates = [];

            liveDrawState.groups.forEach((group, idx) => {
                const sorted = [...group].sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
                
                // 1st Place
                const t1 = { ...sorted[0], group: groupNames[idx], pos: 1 };
                qualifiedTeams.set(`${groupNames[idx]}1`, t1);
                qualifiedTeams.set(t1.code, t1); // Lookup by code

                // 2nd Place
                const t2 = { ...sorted[1], group: groupNames[idx], pos: 2 };
                qualifiedTeams.set(`${groupNames[idx]}2`, t2);
                qualifiedTeams.set(t2.code, t2);

                // 3rd Candidate
                const t3 = { ...sorted[2], group: groupNames[idx], pos: 3 };
                thirdPlaceCandidates.push(t3);
            });

            // Sort & Pick Top 8 Thirds
            thirdPlaceCandidates.sort((a,b) => b.pts - a.pts || b.gd - a.gd || b.gf - a.gf || a.rank - b.rank);
            const top8Thirds = thirdPlaceCandidates.slice(0, 8);
            
            // Add Thirds to Map (Using WC1..WC8 or just code)
            // We'll use a pool for random assignment
            const thirdsPool = shuffle([...top8Thirds]);

            // Helper to safely get team
            const registeredCodes = new Set();

            const getTeam = (key) => {
                const t = qualifiedTeams.get(key);
                if (t) {
                    if (registeredCodes.has(t.code)) return null; // Prevent Duplicate
                    registeredCodes.add(t.code);
                    return t;
                }
                return null;
            };

            const get3rd = () => {
                // Find a 3rd place team that isn't already used
                while(thirdsPool.length > 0) {
                    const t = thirdsPool.pop();
                    if(!registeredCodes.has(t.code)) {
                        registeredCodes.add(t.code);
                        return t;
                    }
                }
                return { name: "TBD", code: "placeholder" };
            };

            // Construct Round 32 Matches with Anti-Duplicate Check
            const round32 = [
                { id: 73, p1: getTeam('A2'), p2: getTeam('B2'), venue: "6/28 LA", winner: null },
                { id: 74, p1: getTeam('E1'), p2: get3rd(), venue: "6/29 Boston", winner: null },
                { id: 75, p1: getTeam('F1'), p2: getTeam('C2'), venue: "6/29 Monterrey", winner: null },
                { id: 76, p1: getTeam('C1'), p2: getTeam('F2'), venue: "6/29 Houston", winner: null },
                { id: 77, p1: getTeam('I1'), p2: get3rd(), venue: "6/30 NY/NJ", winner: null },
                { id: 78, p1: getTeam('E2'), p2: getTeam('I2'), venue: "6/30 Dallas", winner: null },
                { id: 79, p1: getTeam('A1'), p2: get3rd(), venue: "6/30 Mexico City", winner: null },
                { id: 80, p1: getTeam('L1'), p2: get3rd(), venue: "7/1 Atlanta", winner: null },
                { id: 81, p1: getTeam('D1'), p2: get3rd(), venue: "7/1 SF Bay", winner: null },
                { id: 82, p1: getTeam('G1'), p2: get3rd(), venue: "7/1 Seattle", winner: null },
                { id: 83, p1: getTeam('K2'), p2: getTeam('L2'), venue: "7/2 Toronto", winner: null },
                { id: 84, p1: getTeam('H1'), p2: getTeam('J2'), venue: "7/2 LA", winner: null },
                { id: 85, p1: getTeam('B1'), p2: get3rd(), venue: "7/2 Vancouver", winner: null },
                { id: 86, p1: getTeam('J1'), p2: getTeam('H2'), venue: "7/3 Miami", winner: null },
                { id: 87, p1: getTeam('K1'), p2: get3rd(), venue: "7/3 KC", winner: null },
                { id: 88, p1: getTeam('D2'), p2: getTeam('G2'), venue: "7/3 Dallas", winner: null }
            ];

            const prepareRound = (count, startId, venues) => Array(count).fill(null).map((_, i) => ({ id: startId + i, p1: null, p2: null, venue: venues[i], winner: null }));
            const r16Venues = ["7/4 Philadelphia", "7/4 Houston", "7/5 NY/NJ", "7/5 Mexico City", "7/6 Dallas", "7/6 Seattle", "7/7 Atlanta", "7/7 Vancouver"];
            const qfVenues = ["7/9 Boston", "7/10 LA", "7/11 Miami", "7/11 KC"];
            const sfVenues = ["7/14 Dallas", "7/15 Atlanta"];
            const fVenues = ["7/19 NY/NJ"];
            
            tournamentState = { active: true, rounds: [ { name: "32강", matches: round32 }, { name: "16강", matches: prepareRound(8, 89, r16Venues) }, { name: "8강", matches: prepareRound(4, 97, qfVenues) }, { name: "4강", matches: prepareRound(2, 101, sfVenues) }, { name: "결승", matches: prepareRound(1, 103, fVenues) } ], currentRoundIndex: 0, currentMatchIndex: 0 };
            renderBracket(); updateTournamentStatus();
        }

        initGrid(); populateCountrySelect();
    </script>
</body>
</html>